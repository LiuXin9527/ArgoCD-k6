apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  name: hello-world
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  entrypoint: diamond
  templates:
    - name: diamond
      dag:
        tasks:
          - name: wait-sync
            template: wait-sync
          - name: B
            dependencies: [wait-sync]
            template: k6-test-info-apis
          - name: C
            dependencies: [wait-sync]
            template: k6-test-info-apis
          - name: D
            dependencies: [wait-sync]
            template: k6-test-info-apis
          - name: E
            dependencies: [B, C, D]
            template: k6-test-info-apis

    - name: wait-sync
      suspend:
        duration: "5"    # Must be a string. Default unit is seconds. Could also be a Duration, e.g.: "2m", "6h", "1d"

    - name: k6-test-merchant-apis
      container:
        image: loadimpact/k6
        imagePullPolicy: IfNotPresent
        args:
          - run
          #          - -eHOST=https://lcp-settle-api.line-apps-beta.com
          - /k6-scripts/test-merchant-apis.js
        volumeMounts:
          - name: k6-scripts
            mountPath: /k6-scripts
      volumes:
        - name: k6-scripts
          configMap:
            name: k6-scripts
            items:
              - key: 'test-merchant-apis.js'
                path: 'test-merchant-apis.js'
    - name: k6-test-info-apis
      container:
        image: loadimpact/k6
        imagePullPolicy: IfNotPresent
        args:
          - run
          #          - -eHOST=https://lcp-settle-api.line-apps-beta.com
          - /k6-scripts/test-info-apis.js
          - exit 1
        volumeMounts:
          - name: k6-scripts
            mountPath: /k6-scripts
      volumes:
        - name: k6-scripts
          configMap:
            name: k6-scripts
            items:
              - key: 'test-info-apis.js'
                path: 'test-info-apis.js'